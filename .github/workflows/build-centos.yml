name: Build Canary on CentOS

on:
  push: {}
  pull_request: {}

jobs:
  build-centos:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        centos_version: ['quay.io/centos/centos:stream8', 'quay.io/centos/centos:stream9']

    container:
      image: ${{ matrix['centos_version'] }}

    env:
      MAKEFLAGS: -j4

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies and set up LLVM
        run: |
          set -e
          dnf install -y dnf-plugins-core

          CENTOS_VERSION=$(rpm -E %{rhel})

          if [ "$CENTOS_VERSION" = "8" ]; then
            # 使用 vault 替换 mirrorlist
            sed -i 's|mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/CentOS-Stream-*.repo
            sed -i 's|^#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-Stream-*.repo
            dnf clean all
            dnf install -y \
              https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
            dnf config-manager --set-enabled powertools
          else
            dnf install -y \
              https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
            dnf config-manager --set-enabled crb
          fi

          dnf install -y gcc gcc-c++ cmake ninja-build \
            gmp-devel boost-devel z3-devel python3 python3-pip \
            llvm llvm-devel llvm-static clang clang-devel

          echo "LLVM_CONFIG=$(command -v llvm-config)" >> "$GITHUB_ENV"
          echo "CC=$(command -v clang)"           >> "$GITHUB_ENV"
          echo "CXX=$(command -v clang++)"        >> "$GITHUB_ENV"

      - name: Build and install
        run: |
          mkdir build && cd build
          LLVM_CMAKE_DIR=$(llvm-config --cmakedir)

          cmake -G Ninja .. \
            -DCMAKE_INSTALL_PREFIX="$HOME/canary" \
            -DCMAKE_BUILD_TYPE=Debug \
            -DLLVM_BUILD_PATH="$LLVM_CMAKE_DIR" \
            -DLLVM_CONFIG_PATH="$LLVM_CONFIG" \
            -DLLVM_DIR="$LLVM_CMAKE_DIR" \
            -DZ3_DIR="/usr"

          ninja && ninja install

      - name: Add Canary to PATH
        run: echo "$HOME/canary/bin" >> "$GITHUB_PATH"

      - name: Test installation
        run: canary --version || echo "Canary built successfully"