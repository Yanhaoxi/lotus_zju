# Cypher Query Language Examples for PDG
# This file contains example Cypher queries and policies for querying Program Dependence Graphs

# Basic queries - Get all nodes
MATCH (n) RETURN n

# Get all nodes with forward dependencies (forward slice)
MATCH (n)-[*]->(m) RETURN DISTINCT m

# Get all nodes with backward dependencies (backward slice)
MATCH (m)-[*]->(n) RETURN DISTINCT m

# Node and edge selection by type
MATCH (n:INST_FUNCALL) RETURN n
MATCH (n:INST_RET) RETURN n
MATCH (n:PARAM_FORMALIN) RETURN n
MATCH ()-[r:DATA_DEF_USE]->() RETURN r
MATCH ()-[r:CONTROLDEP_BR]->() RETURN r
MATCH ()-[r:DATA_RAW]->() RETURN r
MATCH (n:FUNC_ENTRY) RETURN n

# Function-specific queries - Get return nodes of a function
MATCH (n:FUNC_ENTRY)-[:PARAMETER_OUT]->(ret:INST_RET)
WHERE n.name = 'main'
RETURN ret

# Get formal parameters of a function
MATCH (n:FUNC_ENTRY)-[:PARAMETER_IN]->(param:PARAM_FORMALIN)
WHERE n.name = 'main'
RETURN param

# Get function entry nodes
MATCH (n:FUNC_ENTRY)
WHERE n.name = 'main'
RETURN n

# Path finding - Find paths between nodes
MATCH path = (start)-[*]->(end)
WHERE start.name = 'input' AND end.name = 'output'
RETURN path

# Shortest path between nodes
MATCH path = shortestPath((start)-[*]->(end))
WHERE start.name = 'secret' AND end.name = 'leak'
RETURN path

# Set operations using UNION
MATCH (sources:FUNC_ENTRY)-[:PARAMETER_OUT]->(ret:INST_RET)
WHERE sources.name = 'input'
WITH ret AS sources
MATCH (sinks:FUNC_ENTRY)-[:PARAMETER_IN]->(param:PARAM_FORMALIN)
WHERE sinks.name = 'output'
RETURN sources
UNION
RETURN param AS sinks

# Intersection using WHERE EXISTS
MATCH (dataNodes:INST_FUNCALL)
WHERE EXISTS {
  MATCH (controlNodes:INST_BR)
  WHERE dataNodes.id = controlNodes.id
}
RETURN dataNodes

# Difference: function calls not control nodes
MATCH (calls:INST_FUNCALL)
WHERE NOT (calls:INST_BR)
RETURN calls

# Complex queries - Forward slice from input, backward slice to output
MATCH (input:FUNC_ENTRY)-[:PARAMETER_OUT]->(inputRet:INST_RET)
WHERE input.name = 'getInput'
MATCH (inputRet)-[*]->(n)
MATCH (output:FUNC_ENTRY)-[:PARAMETER_IN]->(outputParam:PARAM_FORMALIN)
WHERE output.name = 'print'
MATCH (m)-[*]->(outputParam)
WHERE n.id = m.id
RETURN n

# Forward slice from function return
MATCH (func:FUNC_ENTRY)-[:PARAMETER_OUT]->(ret:INST_RET)
WHERE func.name = 'getInput'
MATCH (ret)-[*]->(n)
RETURN n

# Policy examples - Check for paths between sources and sinks
MATCH path = (secret:FUNC_ENTRY)-[:PARAMETER_OUT]->(secretRet:INST_RET)-[*]->(output:FUNC_ENTRY)-[:PARAMETER_IN]->(outputParam:PARAM_FORMALIN)
WHERE secret.name = 'secret' AND output.name = 'output'
RETURN path

# Check if path exists between input and sink
MATCH (input:FUNC_ENTRY)-[:PARAMETER_OUT]->(inputRet:INST_RET)
WHERE input.name = 'input'
MATCH (sink:FUNC_ENTRY)-[:PARAMETER_IN]->(sinkParam:PARAM_FORMALIN)
WHERE sink.name = 'sink'
MATCH path = (inputRet)-[*]->(sinkParam)
RETURN path

# Access control policies - Find control dependencies from authorization checks
MATCH (auth:FUNC_ENTRY)-[:PARAMETER_OUT]->(authRet:INST_RET)
WHERE auth.name = 'isAuthorized'
MATCH (authRet)-[:CONTROLDEP_BR]->(check)
MATCH (sensitiveOps:INST_FUNCALL)
WHERE NOT EXISTS {
  MATCH (check)-[:CONTROLDEP_BR]->(sensitiveOps)
}
RETURN sensitiveOps

# Information flow policies - Check for sanitization
MATCH (sources:FUNC_ENTRY)-[:PARAMETER_OUT]->(sourceRet:INST_RET)
WHERE sources.name = 'userInput'
MATCH (sinks:FUNC_ENTRY)-[:PARAMETER_IN]->(sinkParam:PARAM_FORMALIN)
WHERE sinks.name = 'networkSend'
MATCH (sanitizers:FUNC_ENTRY)-[:PARAMETER_OUT]->(sanitizerRet:INST_RET)
WHERE sanitizers.name = 'sanitize'
MATCH path = (sourceRet)-[*]->(sinkParam)
WHERE NOT EXISTS {
  MATCH (sourceRet)-[*]->(sanitizerRet)-[*]->(sinkParam)
}
RETURN path

# Secret does not influence output except by comparison
MATCH (secret:FUNC_ENTRY)-[:PARAMETER_OUT]->(secretRet:INST_RET)
WHERE secret.name = 'getRandom'
MATCH (outputs:FUNC_ENTRY)-[:PARAMETER_IN]->(outputParam:PARAM_FORMALIN)
WHERE outputs.name = 'output'
MATCH (check:INST_BR)
MATCH path = (secretRet)-[*]->(outputParam)
WHERE NOT EXISTS {
  MATCH (secretRet)-[:CONTROLDEP_BR]->(check)
}
RETURN path
